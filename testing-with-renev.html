<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Testing with a reproducible environment | Github actions with R</title>
  <meta name="description" content="An introduction to using github actions with R." />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Testing with a reproducible environment | Github actions with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to using github actions with R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Testing with a reproducible environment | Github actions with R" />
  
  <meta name="twitter:description" content="An introduction to using github actions with R." />
  

<meta name="author" content="Chris Brown, Murray Cadzow, Paula A Martinez, Rhydwyn McGuire, David Neuzerling, David Wilkinson, Saras Windecker" />


<meta name="date" content="2019-12-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="understanding-yaml.html"/>
<link rel="next" href="contributions.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Github Actions with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#what-are-github-actions"><i class="fa fa-check"></i><b>1.1</b> What are GitHub Actions?</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#usethis-wrappers"><i class="fa fa-check"></i><b>1.1.1</b> Usethis Wrappers</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#marketplace-actions"><i class="fa fa-check"></i><b>1.1.2</b> Marketplace Actions</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#extensions"><i class="fa fa-check"></i><b>1.2</b> Extensions</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#more-information-and-useful-links"><i class="fa fa-check"></i><b>1.3</b> More information and useful links</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="packageci.html"><a href="packageci.html"><i class="fa fa-check"></i><b>2</b> Example workflow to set up continuous integration for packages</a><ul>
<li class="chapter" data-level="2.1" data-path="packageci.html"><a href="packageci.html#set-up-package"><i class="fa fa-check"></i><b>2.1</b> Set up package</a><ul>
<li class="chapter" data-level="2.1.1" data-path="packageci.html"><a href="packageci.html#new-project-github-first"><i class="fa fa-check"></i><b>2.1.1</b> New project, GitHub first</a></li>
<li class="chapter" data-level="2.1.2" data-path="packageci.html"><a href="packageci.html#existing-package-with-github"><i class="fa fa-check"></i><b>2.1.2</b> Existing package with Github</a></li>
<li class="chapter" data-level="2.1.3" data-path="packageci.html"><a href="packageci.html#add-github-links-to-description"><i class="fa fa-check"></i><b>2.1.3</b> Add Github links to DESCRIPTION</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="packageci.html"><a href="packageci.html#actions-for-continuous-integration-checks"><i class="fa fa-check"></i><b>2.2</b> Actions for continuous integration checks</a><ul>
<li class="chapter" data-level="2.2.1" data-path="packageci.html"><a href="packageci.html#ci-release-check"><i class="fa fa-check"></i><b>2.2.1</b> CI release check</a></li>
<li class="chapter" data-level="2.2.2" data-path="packageci.html"><a href="packageci.html#ci-full-check"><i class="fa fa-check"></i><b>2.2.2</b> CI full check</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="packageci.html"><a href="packageci.html#adding-secrets"><i class="fa fa-check"></i><b>2.3</b> Adding secrets</a></li>
<li class="chapter" data-level="2.4" data-path="packageci.html"><a href="packageci.html#what-next"><i class="fa fa-check"></i><b>2.4</b> What next?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="understanding-yaml.html"><a href="understanding-yaml.html"><i class="fa fa-check"></i><b>3</b> So what’s actually going on in the yaml file?</a><ul>
<li class="chapter" data-level="3.1" data-path="understanding-yaml.html"><a href="understanding-yaml.html#r-syntax-options"><i class="fa fa-check"></i><b>3.1</b> R Syntax options</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="testing-with-renev.html"><a href="testing-with-renev.html"><i class="fa fa-check"></i><b>4</b> Testing with a reproducible environment</a></li>
<li class="chapter" data-level="5" data-path="contributions.html"><a href="contributions.html"><i class="fa fa-check"></i><b>5</b> Community contributions</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Github actions with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="testing-with-renev" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Testing with a reproducible environment</h1>
<p>We can take testing a step further by setting up an environment that mimics the one we used to train out model, and is set up the same way each time. First we need to set up a <em>lockfile</em> for our package that tells R exactly what packages — including the versions — should be used to reproduce this</p>
<p>We’ll be using the <code>renv</code> package, but a word of warning first: this package is still under active development, so this information may quickly become outdated.</p>
<p>Once you’ve installed <code>renv</code>, open the R project containing your package and run <code>renv::snapshot()</code>. There will be a prompt for your consent to alter some files in your project and system. This function will automatically determine the dependencies used in your package, as well as what packages (and versions) are installed on your system, and will record this information in a lock file.</p>
<p>When you open your project in the future, RStudio will automatically load the packages that are recorded in the snapshot, down to the version number. If the specific versions aren’t available, it will download them and install them from source, or using available binaries. Try restarting your R environment to see this happen. We can trigger this behaviour manually with <code>renv::restore()</code>. To learn more about the <code>renv</code> package, <a href="https://rstudio.github.io/renv/articles/renv.html">read the introductory article</a>.</p>
<p>Now we need to configure GitHub actions to use the snapshot we’ve just set up. In the previous action, we used macOS so that we could take advantage of available package binaries for quick installation. I’m going to be using Ubuntu for this to replicate my person Linux environment, and this means that packages will be installed from source.</p>
<p>Here’s the workflow that I’m using. Read through it and see if you can work out what’s going on, and then we’ll go through the finer details:</p>
<pre><code>on: [push, pull_request]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1
      - uses: r-lib/actions/setup-r@master
        with:
            r-version: &#39;3.6.1&#39;
      - name: Install libcurl
        run: sudo apt-get install libcurl4-openssl-dev
      - name: Install renv 0.9.2
        run: Rscript -e &quot;install.packages(&#39;https://cran.r-project.org/src/contrib/renv_0.9.2.tar.gz&#39;, repos = NULL, type = &#39;source&#39;)&quot;
      - name: Install rcmdcheck 1.3.3
        run: Rscript -e &quot;install.packages(&#39;https://cran.r-project.org/src/contrib/rcmdcheck_1.3.3.tar.gz&#39;, repos = NULL, type = &#39;source&#39;)&quot;
      - name: Check
        run: Rscript -e &quot;renv::restore();rcmdcheck::rcmdcheck(args = &#39;--no-manual&#39;, error_on = &#39;error&#39;)&quot;</code></pre>
<p>There are a few differences with this workflow:</p>
<ul>
<li>I’ve specified a version of R to install, for better reproducibility.</li>
<li>I’ve installing a package for the operating system, <code>libcurl4-openssl-dev</code>. Because we’re installing R packages from source, we need to be sure that our operating system has all of the tools it needs to compile the source files. This particular package is required to use <code>curl</code> within R; this is pretty important, since if you’re doing anything involving the internet, there’s a good chance you’re using <code>curl</code> <em>somewhere</em>. Your specific package may not need this, but I’m including it here as an example of how to run <code>apt-get</code> in GitHub Actions.</li>
<li>We’re installing two packages individually here: <code>renv</code> and <code>rcmdcheck</code>. We need <code>renv</code> to <code>restore</code> our lockfile, so we need to specifically install it before we think about package dependencies. Finally, <code>rcmdcheck</code> is not (usually) a package dependency, and we need it to check our package. Note that we’re manually specifying version numbers here for reproducibility.</li>
<li>Our final step looks a little different. We’re calling <code>renv::restore()</code>, which automatically handles all of our package dependencies. Then we run <code>rcmdcheck</code> as we did before.</li>
</ul>
<p>On Ubuntu, packages are installed from source. This is <strong>much</strong> slower; on one of my packages, testing in a reproducible environment on Ubuntu takes 35 minutes, as opposed to 4 minutes. Caching can make life easier, so let’s take a look at that now.</p>
<p>The idea behind caching is to record our installed R packages so that, for future runs, we can have them readily available instead of installing from source. In one of my packages, caching decreased testing time from 35 minutes to 4 minutes. GitHub caches last a week, so if you push commits infrequently you may not realise the benefits of caching.</p>
<p>We implement caching by adding two steps to the above YAML:</p>
<ul>
<li>We install and use the <code>remotes</code> package to determine the packages that our repository depends upon.</li>
<li>We cache our R libraries folder, given by the <code>R_LIBS_USER</code> environment variable, using the hash of the dependencies as the cache key. If the package dependencies change, so too does the hash, and our cache becomes invalid.</li>
</ul>
<p>There’s a third step that GitHub handles automatically — before the job is complete, the cache is created and our installed packages are stored. On future runs, the cache is unpacked. R will see that the packages are installed and won’t install them again from source.</p>
<p>You can read more about caching in GitHub actions in the <a href="https://github.com/actions/cache">official documentation</a>. An example yaml file is given below:</p>
<pre><code>on: [push, pull_request]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1
      - uses: r-lib/actions/setup-r@master
        with:
            r-version: &#39;3.6.1&#39;
      - name: Install libcurl
        run: sudo apt-get install libcurl4-openssl-dev
      - name: Query dependencies
        run: Rscript -e &quot;install.packages(&#39;remotes&#39;)&quot; -e &quot;saveRDS(remotes::dev_package_deps(dependencies = TRUE), &#39;depends.Rds&#39;)&quot;
      - name: Cache R packages
        if: runner.os != &#39;Windows&#39;
        uses: actions/cache@v1
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-3.6.1-${{ hashFiles(&#39;depends.Rds&#39;) }}
          restore-keys: ${{ runner.os }}-r-3.6.1-
      - name: Install renv 0.9.2
        run: Rscript -e &quot;install.packages(&#39;https://cran.r-project.org/src/contrib/renv_0.9.2.tar.gz&#39;, repos = NULL, type = &#39;source&#39;)&quot;
      - name: Install rcmdcheck 1.3.3
        run: Rscript -e &quot;install.packages(&#39;https://cran.r-project.org/src/contrib/rcmdcheck_1.3.3.tar.gz&#39;, repos = NULL, type = &#39;source&#39;)&quot;
      - name: Check
        run: Rscript -e &quot;renv::restore();rcmdcheck::rcmdcheck(args = &#39;--no-manual&#39;, error_on = &#39;error&#39;)&quot;</code></pre>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="understanding-yaml.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="contributions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
